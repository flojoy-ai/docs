from flojoy import flojoy, DataContainer, DefaultParams
from time import sleep
import serial
import numpy as np
from datetime import datetime
import plotly.graph_objects as go

@flojoy
def SERIAL_SINGLE_MEASUREMENT(default: DataContainer, default_parmas: DefaultParams, comport: str='/dev/ttyUSB0', baudrate: float=9600):
    
    COM_PORT = params['comport']
    BAUD = int(params['baudrate'])
    ser = serial.Serial(COM_PORT, timeout=1, baudrate=BAUD)
    s = ''
    while s == '':
        s = ser.readline().decode()
    reading = s[:-2].split(',')
    reading = np.array(reading)
    reading = reading.astype('float64')
    x = np.arange(0, reading.size)
    return DataContainer(type='ordered_pair', x=x, y=reading)

@flojoy
def SERIAL_SINGLE_MEASUREMENT_MOCK(dc, params):
    print('Running mock version of Serial')
    x = np.linspace(0, 100, 100)
    y = np.linspace(0, 100, 100)
    return DataContainer(x=x, y=y)