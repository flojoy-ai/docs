import can, traceback, json
from can.interface import Bus
from flojoy import flojoy, SerialDevice, Vector, DataContainer, TextBlob
from typing import Optional


@flojoy(deps={"python-can": "4.2.2"})
def CAN_MESSAGE(
    device: SerialDevice,
    message: Vector | Optional[DataContainer] = None,
    # arbitration_id: hex = 0xC0FFEE, TODO: Support hex inputs
    is_extended_id: bool = True,
) -> TextBlob:
    

    s = ""
    try:
        can.rc["interface"] = "slcan"
        can.rc["channel"] = device.get_port()
        can.rc["bitrate"] = 500000

        s = json.dumps(can.rc)

        msg = can.Message(
            data=message.v, arbitration_id=0xC0FFEE, is_extended_id=is_extended_id
        )

        with can.Bus() as bus:
            bus.send(msg)
    except:
        s = traceback.format_exc()

    return TextBlob(s)
